name: Deploy Backend to Production

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allows manual deployment from Actions tab

jobs:
  deploy:
    name: Deploy to Production Server
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the code
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Step 2: Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      # Step 3: Install dependencies
      - name: Install Dependencies
        run: npm ci

      # Step 4: Build TypeScript
      - name: Build Application
        run: npm run build

      # Step 5: Create deployment package
      - name: Create Deployment Package
        run: |
          mkdir -p deploy
          cp -r dist deploy/
          cp -r node_modules deploy/
          cp package.json deploy/
          cp package-lock.json deploy/
          cp ecosystem.config.js deploy/ 2>/dev/null || echo "ecosystem.config.js not found, skipping"
          cp .env.example deploy/
          tar -czf backend-release.tar.gz -C deploy .

      # Step 6: Deploy to server via SSH
      - name: Deploy to Production Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.BACKEND_DEPLOY_HOST }}
          username: ${{ secrets.BACKEND_DEPLOY_USERNAME }}
          key: ${{ secrets.BACKEND_SSH_PRIVATE_KEY }}
          port: ${{ secrets.BACKEND_SSH_PORT || 22 }}
          script: |
            # Set variables
            APP_DIR="/home/api.rojgariindia.com/app"
            BACKUP_DIR="/home/backups/backend"
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)

            # Create backup of current version
            echo "Creating backup..."
            mkdir -p $BACKUP_DIR
            if [ -d "$APP_DIR/dist" ]; then
              tar -czf $BACKUP_DIR/backup_$TIMESTAMP.tar.gz -C $APP_DIR dist/ package.json 2>/dev/null || true
              # Keep only last 5 backups
              ls -t $BACKUP_DIR/backup_*.tar.gz | tail -n +6 | xargs -r rm
            fi

            # Create app directory if it doesn't exist
            mkdir -p $APP_DIR
            cd $APP_DIR

            # Stop PM2 process (if running)
            echo "Stopping application..."
            pm2 stop rojgari-backend 2>/dev/null || echo "App not running, skipping stop"

      # Step 7: Upload deployment package
      - name: Upload Release Package
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.BACKEND_DEPLOY_HOST }}
          username: ${{ secrets.BACKEND_DEPLOY_USERNAME }}
          key: ${{ secrets.BACKEND_SSH_PRIVATE_KEY }}
          port: ${{ secrets.BACKEND_SSH_PORT || 22 }}
          source: "backend-release.tar.gz"
          target: "/home/api.rojgariindia.com/"

      # Step 8: Extract and start application
      - name: Extract and Start Application
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.BACKEND_DEPLOY_HOST }}
          username: ${{ secrets.BACKEND_DEPLOY_USERNAME }}
          key: ${{ secrets.BACKEND_SSH_PRIVATE_KEY }}
          port: ${{ secrets.BACKEND_SSH_PORT || 22 }}
          script: |
            APP_DIR="/home/api.rojgariindia.com/app"
            cd $APP_DIR

            # Extract new version
            echo "Extracting new version..."
            tar -xzf /home/api.rojgariindia.com/backend-release.tar.gz -C $APP_DIR
            rm /home/api.rojgariindia.com/backend-release.tar.gz

            # Ensure .env exists (don't overwrite existing one)
            if [ ! -f .env ]; then
              echo "Warning: .env file not found. Please create it manually."
              cp .env.example .env 2>/dev/null || true
            fi

            # Create required directories
            mkdir -p uploads/profile_photo uploads/resume logs
            chmod -R 755 uploads logs

            # Start application with PM2
            echo "Starting application..."
            if pm2 describe rojgari-backend > /dev/null 2>&1; then
              pm2 restart rojgari-backend
            else
              pm2 start dist/server.js --name "rojgari-backend"
            fi

            # Save PM2 process list
            pm2 save

            # Show status
            pm2 status

      # Step 9: Health check
      - name: Health Check
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.BACKEND_DEPLOY_HOST }}
          username: ${{ secrets.BACKEND_DEPLOY_USERNAME }}
          key: ${{ secrets.BACKEND_SSH_PRIVATE_KEY }}
          port: ${{ secrets.BACKEND_SSH_PORT || 22 }}
          script: |
            echo "Waiting for application to start..."
            sleep 5

            # Check if app is responding
            response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/api/health || echo "000")

            if [ "$response" = "200" ]; then
              echo "‚úÖ Health check passed! Application is running."
              pm2 logs rojgari-backend --lines 10 --nostream
            else
              echo "‚ùå Health check failed! HTTP Status: $response"
              echo "Application logs:"
              pm2 logs rojgari-backend --lines 20 --nostream --err
              exit 1
            fi

      # Step 10: Notify on success
      - name: Deployment Success
        if: success()
        run: |
          echo "üéâ Deployment completed successfully!"
          echo "Backend is now live at: https://${{ secrets.BACKEND_DEPLOY_HOST }}"

      # Step 11: Notify on failure
      - name: Deployment Failed
        if: failure()
        run: |
          echo "‚ùå Deployment failed! Check the logs above for details."
          echo "The previous version should still be running."

      # Step 12: Rollback on failure (optional)
      - name: Rollback on Failure
        if: failure()
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.BACKEND_DEPLOY_HOST }}
          username: ${{ secrets.BACKEND_DEPLOY_USERNAME }}
          key: ${{ secrets.BACKEND_SSH_PRIVATE_KEY }}
          port: ${{ secrets.BACKEND_SSH_PORT || 22 }}
          script: |
            BACKUP_DIR="/home/backups/backend"
            APP_DIR="/home/api.rojgariindia.com/app"

            # Find latest backup
            LATEST_BACKUP=$(ls -t $BACKUP_DIR/backup_*.tar.gz 2>/dev/null | head -1)

            if [ -n "$LATEST_BACKUP" ]; then
              echo "Rolling back to previous version..."
              cd $APP_DIR
              tar -xzf $LATEST_BACKUP
              pm2 restart rojgari-backend
              echo "‚úÖ Rollback completed"
            else
              echo "‚ö†Ô∏è  No backup found for rollback"
            fi
